<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family: Inter, system-ui;
  margin:0;
  background:#eef2f9;
  padding:10px;
  max-width:650px;
  margin:auto;
}

/* HEADER */
.header{
  background:linear-gradient(135deg,#004aad,#0078ff);
  color:white;
  padding:12px;
  text-align:center;
  border-radius:10px;
  font-size:18px;
  box-shadow:0 3px 10px #0003;
  margin-bottom:14px;
}

/* TOP AREA */
.topBar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
  gap:8px;
}
label{
  font-weight:600;
  font-size:14px;
}

/* DATE FIELD */
#date{
  padding:8px;
  border-radius:8px;
  border:1px solid #cbd5f5;
  font-size:14px;
  width:60%;
   flex:1;
}

/* LOGOUT */
.logout{
  background:#dc2626;
  padding:8px 12px;
  border:0;
  border-radius:8px;
  color:white;
  font-size:14px;
  cursor:pointer;
  font-weight:600;
  width:20%;
}

/* CARD */
.card{
  background:white;
  margin-top:10px;
  padding:10px;
  border-radius:10px;
  box-shadow:0 4px 12px #0001;
}
.card.pending{
  border-left:5px solid #f59e0b;
}
.card.done{
  border-left:5px solid #16a34a;
  background:#eaffea;
}

h3{
  margin:0;
  font-size:15px;
}
.info{
  font-size:12px;
  margin:2px 0;
}
.dLabel{
  font-size:14px;
  font-weight:600;
  color:#334155;
  margin-right:6px;
}
/* BUTTONS */
.btn{
  padding:6px 8px;
  border-radius:6px;
  font-weight:600;
  text-decoration:none;
  display:inline-block;
  margin-top:6px;
  font-size:12px;
}
.callBtn{
  background:#0b63d6;
  color:white;
}
.waBtn{
  background:#25D366;
  color:white;
  margin-left:4px;
}


/* SMS Button Style */
.smsBtn{
  background:#2563eb;
  color:white;
  border:1px solid #1e3a8a;
}

.smsBtn:hover{
  background:#1e40af;
  color:white;
  transform:scale(1.05);
}


/* COMMENT BOX */
textarea{
  width:96%;
  margin-top:6px;
  border-radius:6px;
  border:1px solid #cbd5f5;
  padding:8px;
  font-size:13px;
  background:#f9f9f9;
}

/* SAVE BUTTON */
.saveBtn{
  background:#2563eb;
  color:white;
  padding:7px;
  border:0;
  border-radius:6px;
  font-weight:600;
  margin-top:6px;
  cursor:pointer;
  width:100%;
  font-size:13px;
}

/* MESSAGE */
.msg{
  color:green;
  font-size:12px;
  margin-top:3px;
}

/* RESPONSIVE DESIGN */
@media(max-width:450px){
  .topBar{
    flex-direction:column;
     align-items:stretch;
    gap:8px;
  }
  #date, .logout{
    width:96%;
  }
}
</style>

</head>

<body>

<div class="header">ðŸ“ž Faculty Call Duty</div>

<!-- DATE + LOGOUT in same row -->
<div class="topBar">
  <label class="dLabel">Select Exam Date </label>
  <input type="date" id="date" onchange="loadData()">
   <button id="pdfBtn" class="logout" style="background:#16a34a;display:none"
   onclick="downloadPDF()">Report</button>
  <button class="logout" onclick="window.location='index.html'">Logout</button>
</div>

<div id="content"></div>

<script>
const user = JSON.parse(sessionStorage.getItem("user"));
const GAS_URL = "https://script.google.com/macros/s/AKfycby4wz5daoEG7klUARtet4Lzk2DlO6yEUENng6C2XYUvFc45t2PjrppUAWuK1CjRJ-k/exec";

function loadData(){
  let d=document.getElementById("date").value;
  if(!d){ return; }

  let p=d.split("-");
  d=p[2]+"-"+p[1]+"-"+p[0];
  sessionStorage.setItem("selectedDate", d);

  fetch(GAS_URL,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:`action=getData&date=${d}&email=${user.email}`
  })
  .then(r=>r.json())
  .then(res=>render(res.rows));
}

function render(rows){
  let html = "";
  let completed = true;   // ðŸ”¥ NEW: assume completed first

  if(!rows.length){
    document.getElementById("content").innerHTML =
      "<p>No Call Duty Assigned</p>";
    document.getElementById("pdfBtn").style.display = "none";
    return;
  }

  rows.forEach(r=>{
    let status = (r.comments && r.comments.trim()!=="") ? "done" : "pending";

    // ðŸ”¥ NEW: if any comment missing â†’ NOT completed
    if(!r.comments || r.comments.trim()===""){
      completed = false;
    }

    // ðŸ”¥ Get selected date
    let dutyDate = sessionStorage.getItem("selectedDate");

    html += `
    <div class="card ${status}">
      <h3>${r.faculty} (${r.session})</h3>
      <div class="info"><b>College:</b> ${r.college}</div>
      <div class="info"><b>Phone:</b> ${r.phone}</div>

      <a class="btn callBtn" href="tel:${r.phone}">ðŸ“ž Call</a>

      <a class="btn waBtn"
        href="https://wa.me/91${r.phone}?text=${encodeURIComponent(
`ðŸ™ Respected ${r.faculty},
Greetings from Kamaraj College of Engineering and Technology (CoE Office).

ðŸ—“ï¸ On ${dutyDate}, during the ${r.session} session, you have been allotted the Hall Superintendent duty.

ðŸ“Œ Kindly confirm your availability by replying to this message.

ðŸ‘ Thank you.`
        )}"
        target="_blank">ðŸ’¬ WhatsApp</a>

      <a class="btn smsBtn"
        href="sms:91${r.phone}?&body=${encodeURIComponent(
`Respected ${r.faculty},
Greetings from Kamaraj College of Engineering and Technology (CoE Office).

On ${dutyDate}, during the ${r.session} session, you have been allotted the Hall Superintendent duty.

Kindly confirm your availability by replying to this message.

Thank you.`
        )}">ðŸ“© SMS</a>

      <textarea id="c${r.row}">${r.comments||""}</textarea>
      <button class="saveBtn" onclick="save(${r.row})">Save</button>
      <p id="m${r.row}" class="msg"></p>
    </div>`;
  });

  document.getElementById("content").innerHTML = html;

  // ðŸ”¥ NEW: Enable / Disable PDF button
  document.getElementById("pdfBtn").style.display =
    completed ? "block" : "none";
}



function save(row){
  let c=document.getElementById("c"+row).value;

  fetch(GAS_URL,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:`action=updateComment&row=${row}&comment=${encodeURIComponent(c)}&email=${user.email}`
  })
  .then(r=>r.json())
  .then(res=>{
    let m=document.getElementById("m"+row);
    m.textContent="Saved Successfully!";
    setTimeout(()=>m.textContent="",2000);
    loadData();
  });
}

  
 function downloadPDF(){
  let d=sessionStorage.getItem("selectedDate");

  fetch(GAS_URL,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:`action=pdf&date=${d}&email=${user.email}`
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.success){
      alert(res.message);
      return;
    }
    let a=document.createElement("a");
    a.href="data:application/pdf;base64,"+res.data;
    a.download=res.filename;
    a.click();
  });
}
</script>

</body>
</html>


