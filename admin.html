<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family: Inter,system-ui;
  margin:0;
  background:#f1f5f9;
  padding:12px;
}

/* SECTION BOX */
.section{
  background:white;
  padding:12px;
  margin-bottom:14px;
  border-radius:12px;
  box-shadow:0 3px 8px rgba(0,0,0,0.12);
}

/* HEADINGS */
h2,h3{margin:0 0 8px;font-weight:600;color:#0c214d;}

/* BUTTONS */
button{
  padding:10px 16px;
  border:none;
  border-radius:8px;
  background:#005bbb;
  color:white;
  cursor:pointer;
  font-weight:600;
}
button:hover{background:#024a97;}

/* INPUTS */
input,select{
  width:95%;
  padding:9px;
  border-radius:8px;
  border:1px solid #d1d5db;
  margin-top:4px;
  font-size:14px;
}

/*********************  DASHBOARD STAT  **********************/
.dashboard-box{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.stat{
  flex:1 1 130px;
  background:#f9fafc;
  border-radius:10px;
  padding:12px;
  text-align:center;
  box-shadow:0 3px 6px rgba(0,0,0,0.05);
  font-size:14px;
  font-weight:600;
}

/********************* TABLE SCROLL MOBILE **********************/
.table-wrapper{
  overflow-x:auto;
}

/* TABLE */
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
  min-width:650px;
}
th{
  background:#e2e8f0;
  font-weight:700;
}
td,th{
  border:1px solid #dcdfe4;
  padding:6px;
}
tr:nth-child(even){background:#f8fafc;}

@media(max-width:450px){
  table{font-size:12px;}
}
</style>
</head>

<body>

<h2>üìã Admin Dashboard - Call Duty</h2>

<!-- üìä SUMMARY -->
<div class="section">
  <h3>üìä Summary</h3>
  <div class="dashboard-box">
    <div class="stat">Total<br><span id="s1"></span></div>
    <div class="stat">Faculties<br><span id="s2"></span></div>
    <div class="stat">Colleges<br><span id="s3"></span></div>
    <div class="stat">Completed<br><span id="s4"></span></div>
    <div class="stat">Pending<br><span id="s5"></span></div>
  </div>
</div>

<!-- DATE FILTER -->
<div class="section">
  <label><b>üìÖ Filter by Date</b></label>
  <input type="date" id="filterDate" onchange="applyFilters()">
</div>

<!-- SEARCH BOX -->
<div class="section">
  <label><b>üîç Search (Faculty / College)</b></label>
  <input id="search" placeholder="Type to search..." onkeyup="applyFilters()">
</div>

<!-- CSV DOWNLOAD TEMPLATE -->
<div class="section">
  <h3>‚¨á Download Template</h3>
  <button onclick="downloadTemplate()">Download CSV Template</button>
</div>

<!-- CSV UPLOAD -->
<div class="section">
  <h3>‚¨Ü Upload CSV File</h3>
  <input type="file" id="csvFile" accept=".csv">
  <select id="mode">
    <option value="replace">Replace existing</option>
    <option value="append">Append</option>
  </select>
  <button onclick="uploadCsv()">Upload</button>
  <p id="uploadMsg" class="msg"></p>
</div>

<!-- EXCEL DOWNLOAD -->
<div class="section">
  <button onclick="downloadExcel()">üì• Download Full Records</button>
</div>


<!-- RECORDS TABLE -->
<div class="section table-wrapper">
  <div id="records"></div>
</div>

<button onclick="window.location='index.html'">Logout</button>



<script>
const GAS_URL="https://script.google.com/macros/s/AKfycbzt2aN9TjsZQk0F7cI4D1IA1QyJ_74IaB3ThQYsWVC0eC8Ksg1OsAm-zh6OzM8UiMuk/exec";

let allData=[];


/******** FORMAT DATE ********/
function formatDate(d){
  if(!d) return "";
  if(d.includes("T")){
    let dt=new Date(d);
    return ("0"+dt.getDate()).slice(-2)+"-"+("0"+(dt.getMonth()+1)).slice(-2)+"-"+dt.getFullYear();
  }
  let p=d.split("-");
  if(p.length===3) return p[2]+"-"+p[1]+"-"+p[0];
  return d;
}


/******** SHOW SUMMARY ********/
function updateSummary(arr){
  let total=arr.length;
  let completed = arr.filter(r => r[6] && r[6].trim() !== "").length;
  let pending = total - completed;
  let faculties = [...new Set(arr.map(r=>r[1]))].length;
  let colleges = [...new Set(arr.map(r=>r[2]))].length;

  s1.textContent=total;
  s2.textContent=faculties;
  s3.textContent=colleges;
  s4.textContent=completed;
  s5.textContent=pending;
}


/******** DISPLAY TABLE ********/
function display(arr){
  let h=`
  <table>
    <tr>
      <th>Date</th><th>Faculty</th><th>College</th>
      <th>Session</th><th>Phone</th><th>Comments</th>
    </tr>`;
  arr.forEach(r=>{
    h+=`<tr>
      <td>${formatDate(r[0])}</td>
      <td>${r[1]}</td>
      <td>${r[2]}</td>
      <td>${r[3]}</td>
      <td>${r[4]}</td>
      <td>${r[6]}</td>
    </tr>`;
  });
  h+=`</table>`;
  records.innerHTML=h;
}


/******** FILTER (Date + Search Combo) ********/
function applyFilters(){
  let k=search.value.toLowerCase();
  let d=filterDate.value;

  let filtered = allData.filter(r=>{

    // Search filter
    let sMatch = r[1].toLowerCase().includes(k) || r[2].toLowerCase().includes(k);

    // Date filter
    let rowDate="";
    if(r[0].includes("T")){
      let dt=new Date(r[0]);
      rowDate = dt.getFullYear()+"-"+("0"+(dt.getMonth()+1)).slice(-2)+"-"+("0"+dt.getDate()).slice(-2);
    } else rowDate = r[0];

    let dMatch = (!d || d===rowDate);

    return sMatch && dMatch;
  });

  display(filtered);

  if(d) updateSummary(filtered);  // Date summary
  else updateSummary(allData);    // Full summary
}


/******** LOAD RECORDS ********/
function loadRecords(){
  fetch(GAS_URL,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:"action=list"
  })
  .then(r=>r.json())
  .then(res=>{
    allData=res.rows;
    display(allData);
    updateSummary(allData);
  });
}


/******** CSV TEMPLATE ********/
function downloadTemplate(){
  fetch(GAS_URL,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:"action=downloadTemplate"
  })
  .then(r=>r.json())
  .then(res=>{
    const blob=new Blob([res.csv],{type:"text/csv"});
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download=res.filename;
    link.click();
  });
}


/******** UPLOAD CSV ********/
function uploadCsv(){
  let file=document.getElementById("csvFile").files[0];
  if(!file){uploadMsg.textContent="Select file"; return;}

  let reader=new FileReader();
  reader.onload=function(){
    fetch(GAS_URL,{
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:`action=uploadCSV&data=${encodeURIComponent(reader.result)}&mode=${mode.value}`
    })
    .then(r=>r.json())
    .then(res=>{
      uploadMsg.textContent=res.message;
      loadRecords();
    });
  }
  reader.readAsText(file);
}


/******** DOWNLOAD EXCEL ********/
function downloadExcel(){
  fetch(GAS_URL,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:"action=excel"
  })
  .then(r=>r.json())
  .then(res=>{
    const blob=new Blob([res.csv],{type:"text/csv"});
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download=res.filename;
    link.click();
  });
}


/******** PDF REPORT ********/
function generateReport(){
  let d=document.getElementById("reportDate").value;
  if(!d){ pdfMsg.textContent="Select Date"; return;}

  fetch(GAS_URL,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:`action=pdf&date=${d}`
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.success){pdfMsg.textContent=res.message;return;}

    const binary=atob(res.data);
    const bytes=new Uint8Array(binary.length);
    for(let i=0;i<binary.length;i++) bytes[i]=binary.charCodeAt(i);

    const blob=new Blob([bytes],{type:"application/pdf"});
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download=res.filename;
    link.click();
  });
}


/******** PAGE LOAD ********/
window.onload=()=>{
  loadRecords();
};
</script>
</body>
</html>
